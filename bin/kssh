#!/bin/bash

# Copyright (C) 2017 Shawn Wang
#
# You may use, distribute or modify this software under the terms of the MIT license.
#
# You should have received a copy of the MIT license with the software. 
# If not, you can obtain a copy from: https://opensource.org/licenses/MIT

user=ubuntu
identity="-i /path/to/identity/file"
# TODO: add interactive configration of ssh username and identity file per cluster

if [[ $# -eq 0 ]] ; then
    OLD_IFS="$IFS"
    IFS=$'\n'
    # get nodes private ips
    ips=$(kubectl get nodes -o json | jq -r '.items[].status.addresses[].address' | paste - - - | cut -f 1)
    IFS="$OLD_IFS"

    # tmux into all nodes
    echo "tmuxing into all nodes"
    tmux-cssh $( for ip in $ips ; do echo $identity $user@$ip ; done )
elif [[ $# -eq 1 ]] && [[ $1 != "-h" ]]; then
    ssh admin@$1
elif [[ $# -eq 1 ]] && [[ $1 == "-h" ]] ; then
    echo "Kubernetes Tools - kssh"
    echo
    echo "tmux into all nodes: kssh"
    echo "SSH into [node]: kssh [node]"
else
    echo "invalid parameters, use -h for help"
fi