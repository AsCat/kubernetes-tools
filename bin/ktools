#!/bin/bash

# Copyright (C) 2017 Shawn Wang
#
# You may use, distribute or modify this software under the terms of the MIT license.
#
# You should have received a copy of the MIT license with the software. 
# If not, you can obtain a copy from: https://opensource.org/licenses/MIT


function tab_completion() {
	echo "Adding bash completion"
	path=$1/completion/__completion

	if [[ $SHELL == *"zsh"* ]]; then
		echo -e "\nZSH detected. The following lines will be added to $HOME/.zshrc"
		echo -e " autoload -U compaudit compinit bashcompinit\n compaudit && compinit && bashcompinit\n source $path\n"
		read -p "Press [Enter] to continue..."

		echo -e "\n#Kubernetes Tools zsh completion start\nautoload -U compaudit compinit bashcompinit\ncompaudit && compinit && bashcompinit\nsource $path\n#Kubernetes Tools zsh completion end\n" >> $HOME/.zshrc
		echo -e "\n.zshrc updated. Start a new shell to enjoy tab completion!"
	elif [[ $SHELL == *"bash"* ]]; then
		echo -e "\nBASH detected. The following lines will be added to $HOME/.bashrc"
		echo -e " source $path\n"
		read -p "Press [Enter] to continue..."

		echo -e "\n#Kubernetes Tools zsh completion start\nsource $path\n#Kubernetes Tools zsh completion end\n" >> $HOME/.bashrc
		echo -e "\n.bashrc updated. Start a new shell to enjoy tab completion!"
	else
		echo "Only BASH and ZSH supported at this stage. Sorry."
	fi
}

if [[ $# -eq 1 ]] && [[ $1 == "init" ]]; then
	path=$(greadlink -f "$0")
	app_root=$(dirname $(dirname ${path:-"$0"}))

	# set up tab completion
	tab_completion $app_root

elif [[ $# -eq 0 ]] || ([[ $# -eq 1 ]] && [[ $1 == "-h" ]]) ; then
	echo "Kubernetes Tools v1.0.0"
	echo
	echo "===Operation==="
	echo "kcontext: Get current context, set new context"
	echo "kns: Get all namespaces, search namespace by keyword"
	echo "kpod: Get pod in all namespaces or specified namespace"
	echo "kelb: Get ELBs of all namespaces or specified namespace"
	echo "kall: Get all resources of specified namespace"
	echo "kds: Descirbe pod or specified resource in specified namespace"
	echo
	echo "===Debug==="
	echo "klogs: Get logs of a selected container, or all containers in all pods of a namespace"
	echo "ksick: Get all unhealthy pods in all namespaces"
	echo "kexec: Get a shell of a selected container of specified namespace"
	echo "kssh: tmux into all nodes, or ssh into a specified node"
	echo
	echo "===Maintenance==="
	echo "kbak: Backup and restore namespace/cluster"
	echo
	echo "For usage of each tool, run [tool_name] -h"
	echo
	echo "ktools options:"
	echo "Initialize ktools: ktools init"
fi