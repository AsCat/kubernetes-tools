#!/bin/bash

# Copyright (C) 2017 Shawn Wang
#
# You may use, distribute or modify this software under the terms of the MIT license.
#

function copy_tools() {
    # set namespace
    namespace=${1:-default}

    PS3="Please select a pod:"
    OLD_IFS="$IFS"
    IFS=$'\n'
    # get all pods
    pods=($(kubectl get pod -n $namespace|awk '{print $1}'|sed '1d'))
    IFS="$OLD_IFS"
    # select a pod
    select pod in "${pods[@]}"
    do
        PS3="Please select a container:"
        containers=($(kubectl get pod $pod -n $namespace -o jsonpath='{.spec.containers[*].name}'))

        # if there is only one container, get a shell
        if [[ ${#containers[@]} -eq 1 ]] ; then
          selected_container=$containers
        else
          # if there are more than one container, prompt select
          select container in "${containers[@]}"
          do
            selected_container=$container
            break
          done
        fi

        # copy busybox
        dir=`dirname $0`
        echo -e "\nCopying tools to container $selected_container...\n"
        kubectl cp $dir/busybox $namespace/$pod:/tmp -c $selected_container
        kubectl cp $dir/curl $namespace/$pod:/tmp -c $selected_container
        # setup busybox
        kubectl exec $pod -c $selected_container -n $namespace -ti -- sh -c "/tmp/busybox --install /usr/bin && cp /tmp/curl /usr/bin"

        echo -e "\nGetting you a shell in $selected_container...\n"
        # if bash doesn't work, try sh
        kubectl exec $pod -c $selected_container -ti bash -n $namespace 2>/dev/null || kubectl exec $pod -c $selected_container -ti sh -n $namespace
        exit 0
    done
}

# sohw help
show_help() {
  echo -e "Kubernetes Tools - kcp"
  echo -e "- Copy common CLI tools to selected container in default namespace: kcp"
  echo -e "- Copy common CLI tools to selected container in specified namespace: kcp [namespace]\n"
}

show_help
# parse arguments
while [ "$1" != "" ]; do
  case $1 in
    -n | --namespace ) shift
      copy_tools $1
      ;;
    -h | --help ) shift
      exit 0
      ;;
    * ) copy_tools $1
  esac
  shift
done

# prompt pod selection if no arguments
copy_tools