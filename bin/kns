#!/bin/bash

# Kubernetes Tools - Copyright (C) 2017 Shawn Wang
# https://github.com/shawnxlw/kubernetes-tools
#
# You may use, distribute or modify this software under the terms of the MIT license.

source __common

current_context() {
  kubectl config current-context
}

list_namespaces() {
  echo "Current Namespace: $(__current_namespace)"
  echo "Current Context: $(current_context)"
  echo
  echo "All Namespaces in current context:"
  kubectl get ns
}

# prompt ns select
select_ns() {
  echo -e "Setting default namespace:\n"
  PS3="Please select a namespace:"
  OLD_IFS="$IFS"
  IFS=$'\n'
  NAMESPACES=($(kubectl get ns |awk '{print $1}'|sed '1d'))
  IFS="$OLD_IFS"

  select namespace in "${NAMESPACES[@]}"
  do
    update_context $namespace
    break
  done
}

# update context
update_context() {
    echo -e "\nSetting $1 as default namespace in current context...\n"
    kubectl config set-context $(kubectl config current-context) --namespace=$1
    exit 0
}

# sohw help
show_help() {
  echo -e "Kubernetes Tools - kns"
  echo -e "- List current and all namespaces: kns"
  echo -e "- Select a default namespace: kns [-s|--select]"
  echo -e "- Specify a default [namespace]: kns [-n|--namespace] [namespace]\n"
}

# parse arguments
while [ "$1" != "" ]; do
  case $1 in
    -n | --namespace ) shift
      update_context $1
      ;;
    -s | --select ) shift
      select_ns
      ;;
    -h | --help ) shift
      exit 0
      ;;
    * ) update_context $1
  esac
  shift
done

# list namespaces if no arguments
list_namespaces