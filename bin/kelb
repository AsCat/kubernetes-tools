#!/bin/bash

# Copyright (C) 2017 Shawn Wang
#
# You may use, distribute or modify this software under the terms of the MIT license.
#
# You should have received a copy of the MIT license with the software. 
# If not, you can obtain a copy from: https://opensource.org/licenses/MIT

function get_elb() {
	OLD_IFS="$IFS"
    IFS=$'\n'
    # get all services
	services=($(kubectl get svc -n $1|awk '{print $1}'|sed '1d'))
	IFS="$OLD_IFS"

	# loop through each svc and echo ELBs
	for svc in ${services[@]}; do
		elb=($(kubectl get svc "$svc" -n "$1" -o jsonpath='{.status.loadBalancer.ingress[*].hostname}'))
		if [[ -n "$elb" ]]; then
			echo "$elb 		$1		$svc"
		fi
	done
}

if [[ $# -eq 0 ]] ; then
	echo "Usage: kelb [namespace]"
	echo "Listing all ELBs"

	OLD_IFS="$IFS"
    IFS=$'\n'
    # get all services
	namespaces=($(kubectl get ns|awk '{print $1}'|sed '1d'))
	IFS="$OLD_IFS"

	echo "ELB 		Namespace 		ServiceName"
	# loop through each namespace
	for ns in ${namespaces[@]}; do
		get_elb $ns
	done

elif [[ $# -eq 1 ]] && [[ $1 != '-h' ]] ; then
	echo "Listing EBLs of namespace $1"

	echo "ELB 		Namespace 		ServiceName"
	get_elb $1
elif [[ $# -eq 1 ]] && [[ $1 == '-h' ]] ; then
	echo "Kubernetes Tools - kelb"
    echo
    echo "Get EBL endpoints of all namespaces: kelb"
    echo "Get ELB endpoints of [namespace]: kelb [namespace]"
else
	echo "invalid parameters, use -h for help"
fi